<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日食谱</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-utensils"></i> 每日食谱
            </div>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> 首页</a>
                <a href="/history.html"><i class="fas fa-calendar-alt"></i> 历史记录</a>
                <a href="/gallery.html"><i class="fas fa-camera"></i> 我的作品</a>
                <a href="/profile.html"><i class="fas fa-user"></i> 个人中心</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="date-header">
            <h1>今日推荐 <i class="fas fa-star" style="color: #ffd700;"></i></h1>
            <p id="current-date"></p>
            <div class="api-status">
                <button id="check-api" class="btn"><i class="fas fa-network-wired"></i> 检查API连接</button>
                <span id="api-status-indicator"></span>
            </div>
            <button id="loginBtn" class="btn" style="display: none;"><i class="fas fa-sign-in-alt"></i> 登录</button>
        </div>

        <div class="preferences-section">
            <h2><i class="fas fa-sliders-h"></i> 偏好设置</h2>
            <div class="preferences-form">
                <div class="preferences-tags">
                    <div class="preference-tag" data-value="家常菜">家常菜</div>
                    <div class="preference-tag" data-value="川菜">川菜</div>
                    <div class="preference-tag" data-value="粤菜">粤菜</div>
                    <div class="preference-tag" data-value="清淡">清淡</div>
                    <div class="preference-tag" data-value="麻辣">麻辣</div>
                    <div class="preference-tag" data-value="快手菜">快手菜</div>
                    <div class="preference-tag" data-value="海鲜">海鲜</div>
                    <div class="preference-tag" data-value="素食">素食</div>
                    <div class="preference-tag" data-value="肉类">肉类</div>
                </div>
                <div class="preferences-input">
                    <input type="text" class="input-field" id="preference-input" placeholder="输入其他偏好，例如：不辣、适合儿童、低脂、适合2人份...">
                    <button class="submit-button" id="refresh-button">获取推荐</button>
                </div>
            </div>
        </div>

        <div class="recipes-grid" id="recipes-container">
            <div class="loading" id="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i> 正在加载推荐菜品...
            </div>
        </div>
        
        <div id="api-status-details" class="api-status-details" style="display: none;">
            <h3>API连接诊断</h3>
            <pre id="api-status-content"></pre>
        </div>

        <div id="api-status" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <h4>API状态</h4>
            <div id="api-status-content">正在检查...</div>
            <button id="check-api-status-btn">检查API状态</button>
            <button id="force-refresh-btn" style="margin-left: 10px; background-color: #ffcc00;">强制刷新推荐</button>
        </div>
    </main>

    <!-- 详情模态框 -->
    <div class="modal" id="recipe-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">菜品详情</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 动态生成的详情内容将在这里显示 -->
            </div>
        </div>
    </div>

    <script type="module">
        import { getDailyRecommendations, login, diagnoseAPI, CONFIG, clearCache } from '/js/api.js';

        // 设置当前日期
        const dateElement = document.getElementById('current-date');
        dateElement.textContent = new Date().toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // API状态检查
        document.getElementById('check-api').addEventListener('click', async () => {
            const statusIndicator = document.getElementById('api-status-indicator');
            const statusDetails = document.getElementById('api-status-details');
            const statusContent = document.getElementById('api-status-content');
            
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
            statusDetails.style.display = 'none';
            
            try {
                const diagnosticResults = await diagnoseAPI();
                
                if (diagnosticResults.tests.network.success && diagnosticResults.tests.health.success) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> API连接正常';
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle" style="color: red;"></i> API连接异常';
                }
                
                statusContent.textContent = JSON.stringify(diagnosticResults, null, 2);
                statusDetails.style.display = 'block';
            } catch (error) {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> 检查失败';
                statusContent.textContent = error.message;
                statusDetails.style.display = 'block';
            }
        });

        // 加载推荐菜品
        async function loadRecommendations(forceRefresh = false, preferences = '') {
            // 获取或创建加载指示器
            let loadingIndicator = document.getElementById('loading-indicator');
            const recipesContainer = document.getElementById('recipes-container');
            
            // 如果加载指示器不存在，创建一个新的
            if (!loadingIndicator) {
                console.log('创建新的加载指示器');
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'loading-indicator';
                loadingIndicator.className = 'loading';
                loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载推荐菜品...';
                
                // 确保recipes容器存在
                if (recipesContainer) {
                    // 清空当前内容
                    recipesContainer.innerHTML = '';
                    // 添加加载指示器
                    recipesContainer.appendChild(loadingIndicator);
                } else {
                    console.error('无法找到recipes容器');
                    return; // 没有容器就不继续执行
                }
            }
            
            // 确保显示加载指示器
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            try {
                // 添加一个随机参数避免缓存
                console.log('正在获取每日推荐...');
                
                // 如果强制刷新，先清除缓存
                if (forceRefresh) {
                    console.log('强制刷新，尝试清除缓存...');
                    try {
                        const result = await clearCache();
                        console.log('清除缓存结果:', result);
                    } catch (cacheError) {
                        console.error('清除缓存失败:', cacheError);
                        // 继续执行，即使缓存清除失败
                    }
                }
                
                // 带上时间戳和强制刷新参数
                const timestamp = Date.now();
                const recommendations = await getDailyRecommendations(forceRefresh, preferences);
                console.log('获取到的推荐:', recommendations);
                
                // 检查推荐是否为数组
                if (!Array.isArray(recommendations)) {
                    throw new Error('推荐数据格式错误');
                }
                
                // 确保recipesContainer仍然存在
                if (!recipesContainer) {
                    console.error('recipes容器在API请求过程中消失了');
                    return;
                }
                
                // 显示推荐
                let html = '';
                recommendations.forEach((recipe, index) => {
                    // 使用生成的图片或默认图片
                    const imageUrl = recipe.图片 || `https://source.unsplash.com/featured/300x200?food,chinese,cooking&sig=${Math.floor(Math.random() * 1000)}`;
                    
                    html += `
                        <div class="recipe-card">
                            <img src="${imageUrl}" alt="${recipe.菜名}" class="recipe-image" onerror="this.src='https://source.unsplash.com/featured/300x200?food,chinese,cooking'">
                            <div class="recipe-content">
                                <h2 class="recipe-title">${recipe.菜名}</h2>
                                <p class="recipe-description">${recipe.简短描述}</p>
                                <div class="tags">
                                    ${recipe.主要食材.map(item => `<span class="tag">${item}</span>`).join('')}
                                </div>
                                <div class="recipe-info">
                                    <div class="recipe-stats">
                                        <span class="stat"><i class="fas fa-clock"></i> ${recipe.所需时间}</span>
                                        <span class="stat"><i class="fas fa-fire"></i> ${recipe.难度级别}</span>
                                    </div>
                                    <button class="action-button view-details" data-index="${index}">查看详情</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                recipesContainer.innerHTML = html;

                // 添加查看详情事件
                document.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', () => {
                        const index = button.dataset.index;
                        showRecipeDetails(recommendations[index]);
                    });
                });
            } catch (error) {
                console.error('加载推荐失败:', error);
                if (recipesContainer) {
                    recipesContainer.innerHTML = `
                        <div class="error-message">
                            <p>加载推荐失败: ${error.message}</p>
                            <button id="retry-btn">重试</button>
                        </div>
                    `;
                    
                    document.getElementById('retry-btn')?.addEventListener('click', () => {
                        loadRecommendations(true);
                    });
                }
            } finally {
                // 隐藏加载指示器（如果存在）
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        // 检查是否已登录（通过尝试获取推荐来判断）
        async function checkLoginStatus() {
            try {
                await getDailyRecommendations();
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'none';
                loadRecommendations();
            } catch (error) {
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'block';
                document.getElementById('recipes-container').innerHTML = '<p class="error">请先登录</p>';
            }
        }

        // 登录按钮点击事件
        document.getElementById('loginBtn')?.addEventListener('click', async () => {
            try {
                if (await login()) {
                    checkLoginStatus();
                } else {
                    alert('登录失败，请重试');
                }
            } catch (error) {
                console.error('登录错误:', error);
                alert('登录过程中发生错误: ' + error.message);
            }
        });

        // API状态检查函数
        async function checkAPIStatus() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML = '正在检查...';
            
            try {
                // 检查基本健康状态
                const response = await fetch(`${CONFIG.current.apiBase}/api/health`);
                const health = await response.json();
                
                statusContent.innerHTML = `
                    <p><strong>API状态:</strong> ${health.status}</p>
                    <p><strong>JWT密钥设置:</strong> ${health.env.hasJwtSecret ? '✅' : '❌'}</p>
                    <p><strong>GROQ密钥设置:</strong> ${health.env.hasGroqKey ? '✅' : '❌'}</p>
                    <p><strong>时间戳:</strong> ${health.timestamp}</p>
                    <p><button id="test-recommendations-btn">测试推荐API</button></p>
                `;
                
                document.getElementById('test-recommendations-btn')?.addEventListener('click', testRecommendationAPI);
            } catch (error) {
                statusContent.innerHTML = `<p>检查失败: ${error.message}</p>`;
            }
        }

        // 测试推荐API函数
        async function testRecommendationAPI() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML += '<p>正在测试推荐API...</p>';
            
            try {
                const startTime = Date.now();
                // 使用时间戳参数避免缓存
                const response = await fetch(`${CONFIG.current.apiBase}/api/recommendations?t=${Date.now()}&nocache=true`);
                const recommendations = await response.json();
                const endTime = Date.now();
                
                statusContent.innerHTML += `
                    <p>推荐API响应时间: ${endTime - startTime}ms</p>
                    <p>推荐数量: ${Array.isArray(recommendations) ? recommendations.length : '未知'}</p>
                    <p>内容样例: ${JSON.stringify(recommendations).substring(0, 100)}...</p>
                    <p><button id="refresh-recommendations-btn">刷新页面推荐</button></p>
                `;
                
                document.getElementById('refresh-recommendations-btn')?.addEventListener('click', () => loadRecommendations(true));
            } catch (error) {
                statusContent.innerHTML += `<p>推荐API测试失败: ${error.message}</p>`;
            }
        }

        // 绑定API状态检查按钮
        document.getElementById('check-api-status-btn')?.addEventListener('click', checkAPIStatus);
        
        // 绑定强制刷新按钮
        document.getElementById('force-refresh-btn')?.addEventListener('click', () => loadRecommendations(true));

        // 页面加载时执行加载推荐
        window.addEventListener('DOMContentLoaded', () => {
            loadRecommendations();
        });

        // 将CONFIG暴露到全局，以便在其他地方使用
        window.CONFIG = CONFIG;

        // 添加显示菜品详情的函数
        function showRecipeDetails(recipe) {
            const modal = document.getElementById('recipe-modal');
            const modalBody = document.getElementById('modal-body');
            
            // 使用生成的图片或默认图片
            const imageUrl = recipe.图片 || `https://source.unsplash.com/featured/800x400?food,chinese,cooking&sig=${Math.floor(Math.random() * 1000)}`;
            
            modalBody.innerHTML = `
                <img src="${imageUrl}" alt="${recipe.菜名}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 1.5rem;" onerror="this.src='https://source.unsplash.com/featured/800x400?food,chinese,cooking'">
                
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">${recipe.菜名}</h3>
                <p style="color: #666; margin-bottom: 1.5rem;">${recipe.简短描述}</p>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <span style="background: #e9ecef; padding: 0.5rem 1rem; border-radius: 20px;">
                        <i class="fas fa-clock"></i> ${recipe.所需时间}
                    </span>
                    <span style="background: #e9ecef; padding: 0.5rem 1rem; border-radius: 20px;">
                        <i class="fas fa-fire"></i> ${recipe.难度级别}
                    </span>
                </div>
                
                <div class="recipe-sections">
                    <div class="ingredients">
                        <h3><i class="fas fa-list"></i> 食材清单</h3>
                        <ul class="ingredient-list">
                            ${recipe.详细食材.map(item => `
                                <li>
                                    <span>${item.名称}</span>
                                    <span>${item.数量}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="steps">
                        <h3><i class="fas fa-tasks"></i> 烹饪步骤</h3>
                        <ol class="step-list">
                            ${recipe.烹饪步骤.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
                
                <div class="tips">
                    <h3><i class="fas fa-lightbulb"></i> 小贴士</h3>
                    <p>${recipe.小贴士}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // 添加关闭模态框的事件处理
        document.querySelector('.close-button').addEventListener('click', () => {
            document.getElementById('recipe-modal').style.display = 'none';
        });

        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('recipe-modal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // 获取选中的偏好
        function getSelectedPreferences() {
            const activeTags = document.querySelectorAll('.preference-tag.active');
            const tagValues = Array.from(activeTags).map(tag => tag.dataset.value);
            
            const inputValue = document.getElementById('preference-input').value.trim();
            if (inputValue) {
                tagValues.push(inputValue);
            }
            
            return tagValues.join('、');
        }

        // 偏好标签点击事件
        document.querySelectorAll('.preference-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('active');
            });
        });

        // 刷新按钮点击事件
        document.getElementById('refresh-button').addEventListener('click', () => {
            const preferences = getSelectedPreferences();
            loadRecommendations(true, preferences);
        });
    </script>
</body>
</html> 