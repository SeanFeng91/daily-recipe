<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日食谱</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-utensils"></i> 每日食谱
            </div>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> 首页</a>
                <a href="/history.html"><i class="fas fa-calendar-alt"></i> 历史记录</a>
                <a href="/gallery.html"><i class="fas fa-camera"></i> 我的作品</a>
                <a href="/profile.html"><i class="fas fa-user"></i> 个人中心</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="date-header">
            <h1>今日推荐 <i class="fas fa-star" style="color: #ffd700;"></i></h1>
            <p id="current-date"></p>
            <div class="api-status">
                <button id="check-api" class="btn"><i class="fas fa-network-wired"></i> 检查API连接</button>
                <span id="api-status-indicator"></span>
            </div>
            <button id="loginBtn" class="btn" style="display: none;"><i class="fas fa-sign-in-alt"></i> 登录</button>
        </div>

        <div class="recipes-grid" id="recipes-container">
            <div class="loading" id="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i> 正在加载推荐菜品...
            </div>
        </div>
        
        <div id="api-status-details" class="api-status-details" style="display: none;">
            <h3>API连接诊断</h3>
            <pre id="api-status-content"></pre>
        </div>

        <div id="api-status" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <h4>API状态</h4>
            <div id="api-status-content">正在检查...</div>
            <button id="check-api-status-btn">检查API状态</button>
            <button id="force-refresh-btn" style="margin-left: 10px; background-color: #ffcc00;">强制刷新推荐</button>
        </div>
    </main>

    <script type="module">
        import { getDailyRecommendations, login, diagnoseAPI, CONFIG } from '/js/api.js';

        // 设置当前日期
        const dateElement = document.getElementById('current-date');
        dateElement.textContent = new Date().toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // API状态检查
        document.getElementById('check-api').addEventListener('click', async () => {
            const statusIndicator = document.getElementById('api-status-indicator');
            const statusDetails = document.getElementById('api-status-details');
            const statusContent = document.getElementById('api-status-content');
            
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
            statusDetails.style.display = 'none';
            
            try {
                const diagnosticResults = await diagnoseAPI();
                
                if (diagnosticResults.tests.network.success && diagnosticResults.tests.health.success) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> API连接正常';
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle" style="color: red;"></i> API连接异常';
                }
                
                statusContent.textContent = JSON.stringify(diagnosticResults, null, 2);
                statusDetails.style.display = 'block';
            } catch (error) {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> 检查失败';
                statusContent.textContent = error.message;
                statusDetails.style.display = 'block';
            }
        });

        // 加载推荐菜品
        async function loadRecommendations(forceRefresh = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const recipesContainer = document.getElementById('recipes-container');
            
            // 确保显示加载指示器
            loadingIndicator.style.display = 'block';
            
            try {
                // 添加一个随机参数避免缓存
                console.log('正在获取每日推荐...');
                
                // 如果强制刷新，先清除缓存
                if (forceRefresh) {
                    console.log('强制刷新，尝试清除缓存...');
                    try {
                        const clearCacheResponse = await fetch(`${CONFIG.current.apiBase}/api/clear-cache`);
                        console.log('清除缓存响应:', await clearCacheResponse.json());
                    } catch (cacheError) {
                        console.error('清除缓存失败:', cacheError);
                    }
                }
                
                // 带上时间戳和强制刷新参数
                const timestamp = Date.now();
                const recommendations = await getDailyRecommendations(forceRefresh);
                console.log('获取到的推荐:', recommendations);
                
                // 检查推荐是否为数组
                if (!Array.isArray(recommendations)) {
                    throw new Error('推荐数据格式错误');
                }
                
                // 显示推荐
                let html = '';
                recommendations.forEach(recipe => {
                    html += `
                        <div class="recipe-card">
                            <h3>${recipe.菜名}</h3>
                            <p>${recipe.简短描述}</p>
                            <div class="recipe-details">
                                <span>🕒 ${recipe.所需时间}</span>
                                <span>📊 ${recipe.难度级别}</span>
                            </div>
                            <div class="recipe-ingredients">
                                <strong>主要食材:</strong> ${recipe.主要食材.join(', ')}
                            </div>
                        </div>
                    `;
                });
                
                recipesContainer.innerHTML = html;
            } catch (error) {
                console.error('加载推荐失败:', error);
                recipesContainer.innerHTML = `
                    <div class="error-message">
                        <p>加载推荐失败: ${error.message}</p>
                        <button id="retry-btn">重试</button>
                    </div>
                `;
                
                document.getElementById('retry-btn')?.addEventListener('click', () => {
                    loadRecommendations(true);
                });
            } finally {
                // 隐藏加载指示器
                loadingIndicator.style.display = 'none';
            }
        }

        // 检查是否已登录（通过尝试获取推荐来判断）
        async function checkLoginStatus() {
            try {
                await getDailyRecommendations();
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'none';
                loadRecommendations();
            } catch (error) {
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'block';
                document.getElementById('recipes-container').innerHTML = '<p class="error">请先登录</p>';
            }
        }

        // 登录按钮点击事件
        document.getElementById('loginBtn')?.addEventListener('click', async () => {
            try {
                if (await login()) {
                    checkLoginStatus();
                } else {
                    alert('登录失败，请重试');
                }
            } catch (error) {
                console.error('登录错误:', error);
                alert('登录过程中发生错误: ' + error.message);
            }
        });

        // API状态检查函数
        async function checkAPIStatus() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML = '正在检查...';
            
            try {
                // 检查基本健康状态
                const response = await fetch(`${CONFIG.current.apiBase}/api/health`);
                const health = await response.json();
                
                statusContent.innerHTML = `
                    <p><strong>API状态:</strong> ${health.status}</p>
                    <p><strong>JWT密钥设置:</strong> ${health.env.hasJwtSecret ? '✅' : '❌'}</p>
                    <p><strong>GROQ密钥设置:</strong> ${health.env.hasGroqKey ? '✅' : '❌'}</p>
                    <p><strong>时间戳:</strong> ${health.timestamp}</p>
                    <p><button id="test-recommendations-btn">测试推荐API</button></p>
                `;
                
                document.getElementById('test-recommendations-btn')?.addEventListener('click', testRecommendationAPI);
            } catch (error) {
                statusContent.innerHTML = `<p>检查失败: ${error.message}</p>`;
            }
        }

        // 测试推荐API函数
        async function testRecommendationAPI() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML += '<p>正在测试推荐API...</p>';
            
            try {
                const startTime = Date.now();
                // 使用时间戳参数避免缓存
                const response = await fetch(`${CONFIG.current.apiBase}/api/recommendations?t=${Date.now()}&nocache=true`);
                const recommendations = await response.json();
                const endTime = Date.now();
                
                statusContent.innerHTML += `
                    <p>推荐API响应时间: ${endTime - startTime}ms</p>
                    <p>推荐数量: ${Array.isArray(recommendations) ? recommendations.length : '未知'}</p>
                    <p>内容样例: ${JSON.stringify(recommendations).substring(0, 100)}...</p>
                    <p><button id="refresh-recommendations-btn">刷新页面推荐</button></p>
                `;
                
                document.getElementById('refresh-recommendations-btn')?.addEventListener('click', () => loadRecommendations(true));
            } catch (error) {
                statusContent.innerHTML += `<p>推荐API测试失败: ${error.message}</p>`;
            }
        }

        // 绑定API状态检查按钮
        document.getElementById('check-api-status-btn')?.addEventListener('click', checkAPIStatus);
        
        // 绑定强制刷新按钮
        document.getElementById('force-refresh-btn')?.addEventListener('click', () => loadRecommendations(true));

        // 页面加载时执行加载推荐
        window.addEventListener('DOMContentLoaded', () => {
            loadRecommendations();
        });

        // 将CONFIG暴露到全局，以便在其他地方使用
        window.CONFIG = CONFIG;
    </script>
</body>
</html> 