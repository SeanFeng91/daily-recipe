<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥é£Ÿè°±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-utensils"></i> æ¯æ—¥é£Ÿè°±
            </div>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> é¦–é¡µ</a>
                <a href="/history.html"><i class="fas fa-calendar-alt"></i> å†å²è®°å½•</a>
                <a href="/gallery.html"><i class="fas fa-camera"></i> æˆ‘çš„ä½œå“</a>
                <a href="/profile.html"><i class="fas fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="date-header">
            <h1>ä»Šæ—¥æ¨è <i class="fas fa-star" style="color: #ffd700;"></i></h1>
            <p id="current-date"></p>
            <div class="api-status">
                <button id="check-api" class="btn"><i class="fas fa-network-wired"></i> æ£€æŸ¥APIè¿æ¥</button>
                <span id="api-status-indicator"></span>
            </div>
            <button id="loginBtn" class="btn" style="display: none;"><i class="fas fa-sign-in-alt"></i> ç™»å½•</button>
        </div>

        <div class="recipes-grid" id="recipes-container">
            <div class="loading" id="loading-indicator">
                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½æ¨èèœå“...
            </div>
        </div>
        
        <div id="api-status-details" class="api-status-details" style="display: none;">
            <h3>APIè¿æ¥è¯Šæ–­</h3>
            <pre id="api-status-content"></pre>
        </div>

        <div id="api-status" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <h4>APIçŠ¶æ€</h4>
            <div id="api-status-content">æ­£åœ¨æ£€æŸ¥...</div>
            <button id="check-api-status-btn">æ£€æŸ¥APIçŠ¶æ€</button>
            <button id="force-refresh-btn" style="margin-left: 10px; background-color: #ffcc00;">å¼ºåˆ¶åˆ·æ–°æ¨è</button>
        </div>
    </main>

    <script type="module">
        import { getDailyRecommendations, login, diagnoseAPI, CONFIG } from '/js/api.js';

        // è®¾ç½®å½“å‰æ—¥æœŸ
        const dateElement = document.getElementById('current-date');
        dateElement.textContent = new Date().toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // APIçŠ¶æ€æ£€æŸ¥
        document.getElementById('check-api').addEventListener('click', async () => {
            const statusIndicator = document.getElementById('api-status-indicator');
            const statusDetails = document.getElementById('api-status-details');
            const statusContent = document.getElementById('api-status-content');
            
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ£€æŸ¥ä¸­...';
            statusDetails.style.display = 'none';
            
            try {
                const diagnosticResults = await diagnoseAPI();
                
                if (diagnosticResults.tests.network.success && diagnosticResults.tests.health.success) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> APIè¿æ¥æ­£å¸¸';
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle" style="color: red;"></i> APIè¿æ¥å¼‚å¸¸';
                }
                
                statusContent.textContent = JSON.stringify(diagnosticResults, null, 2);
                statusDetails.style.display = 'block';
            } catch (error) {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> æ£€æŸ¥å¤±è´¥';
                statusContent.textContent = error.message;
                statusDetails.style.display = 'block';
            }
        });

        // åŠ è½½æ¨èèœå“
        async function loadRecommendations(forceRefresh = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const recipesContainer = document.getElementById('recipes-container');
            
            // ç¡®ä¿æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            loadingIndicator.style.display = 'block';
            
            try {
                // æ·»åŠ ä¸€ä¸ªéšæœºå‚æ•°é¿å…ç¼“å­˜
                console.log('æ­£åœ¨è·å–æ¯æ—¥æ¨è...');
                
                // å¦‚æœå¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆæ¸…é™¤ç¼“å­˜
                if (forceRefresh) {
                    console.log('å¼ºåˆ¶åˆ·æ–°ï¼Œå°è¯•æ¸…é™¤ç¼“å­˜...');
                    try {
                        const clearCacheResponse = await fetch(`${CONFIG.current.apiBase}/api/clear-cache`);
                        console.log('æ¸…é™¤ç¼“å­˜å“åº”:', await clearCacheResponse.json());
                    } catch (cacheError) {
                        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', cacheError);
                    }
                }
                
                // å¸¦ä¸Šæ—¶é—´æˆ³å’Œå¼ºåˆ¶åˆ·æ–°å‚æ•°
                const timestamp = Date.now();
                const recommendations = await getDailyRecommendations(forceRefresh);
                console.log('è·å–åˆ°çš„æ¨è:', recommendations);
                
                // æ£€æŸ¥æ¨èæ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(recommendations)) {
                    throw new Error('æ¨èæ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                // æ˜¾ç¤ºæ¨è
                let html = '';
                recommendations.forEach(recipe => {
                    html += `
                        <div class="recipe-card">
                            <h3>${recipe.èœå}</h3>
                            <p>${recipe.ç®€çŸ­æè¿°}</p>
                            <div class="recipe-details">
                                <span>ğŸ•’ ${recipe.æ‰€éœ€æ—¶é—´}</span>
                                <span>ğŸ“Š ${recipe.éš¾åº¦çº§åˆ«}</span>
                            </div>
                            <div class="recipe-ingredients">
                                <strong>ä¸»è¦é£Ÿæ:</strong> ${recipe.ä¸»è¦é£Ÿæ.join(', ')}
                            </div>
                        </div>
                    `;
                });
                
                recipesContainer.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æ¨èå¤±è´¥:', error);
                recipesContainer.innerHTML = `
                    <div class="error-message">
                        <p>åŠ è½½æ¨èå¤±è´¥: ${error.message}</p>
                        <button id="retry-btn">é‡è¯•</button>
                    </div>
                `;
                
                document.getElementById('retry-btn')?.addEventListener('click', () => {
                    loadRecommendations(true);
                });
            } finally {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                loadingIndicator.style.display = 'none';
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆé€šè¿‡å°è¯•è·å–æ¨èæ¥åˆ¤æ–­ï¼‰
        async function checkLoginStatus() {
            try {
                await getDailyRecommendations();
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'none';
                loadRecommendations();
            } catch (error) {
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) loginBtn.style.display = 'block';
                document.getElementById('recipes-container').innerHTML = '<p class="error">è¯·å…ˆç™»å½•</p>';
            }
        }

        // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('loginBtn')?.addEventListener('click', async () => {
            try {
                if (await login()) {
                    checkLoginStatus();
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                alert('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        });

        // APIçŠ¶æ€æ£€æŸ¥å‡½æ•°
        async function checkAPIStatus() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML = 'æ­£åœ¨æ£€æŸ¥...';
            
            try {
                // æ£€æŸ¥åŸºæœ¬å¥åº·çŠ¶æ€
                const response = await fetch(`${CONFIG.current.apiBase}/api/health`);
                const health = await response.json();
                
                statusContent.innerHTML = `
                    <p><strong>APIçŠ¶æ€:</strong> ${health.status}</p>
                    <p><strong>JWTå¯†é’¥è®¾ç½®:</strong> ${health.env.hasJwtSecret ? 'âœ…' : 'âŒ'}</p>
                    <p><strong>GROQå¯†é’¥è®¾ç½®:</strong> ${health.env.hasGroqKey ? 'âœ…' : 'âŒ'}</p>
                    <p><strong>æ—¶é—´æˆ³:</strong> ${health.timestamp}</p>
                    <p><button id="test-recommendations-btn">æµ‹è¯•æ¨èAPI</button></p>
                `;
                
                document.getElementById('test-recommendations-btn')?.addEventListener('click', testRecommendationAPI);
            } catch (error) {
                statusContent.innerHTML = `<p>æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æµ‹è¯•æ¨èAPIå‡½æ•°
        async function testRecommendationAPI() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML += '<p>æ­£åœ¨æµ‹è¯•æ¨èAPI...</p>';
            
            try {
                const startTime = Date.now();
                // ä½¿ç”¨æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
                const response = await fetch(`${CONFIG.current.apiBase}/api/recommendations?t=${Date.now()}&nocache=true`);
                const recommendations = await response.json();
                const endTime = Date.now();
                
                statusContent.innerHTML += `
                    <p>æ¨èAPIå“åº”æ—¶é—´: ${endTime - startTime}ms</p>
                    <p>æ¨èæ•°é‡: ${Array.isArray(recommendations) ? recommendations.length : 'æœªçŸ¥'}</p>
                    <p>å†…å®¹æ ·ä¾‹: ${JSON.stringify(recommendations).substring(0, 100)}...</p>
                    <p><button id="refresh-recommendations-btn">åˆ·æ–°é¡µé¢æ¨è</button></p>
                `;
                
                document.getElementById('refresh-recommendations-btn')?.addEventListener('click', () => loadRecommendations(true));
            } catch (error) {
                statusContent.innerHTML += `<p>æ¨èAPIæµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // ç»‘å®šAPIçŠ¶æ€æ£€æŸ¥æŒ‰é’®
        document.getElementById('check-api-status-btn')?.addEventListener('click', checkAPIStatus);
        
        // ç»‘å®šå¼ºåˆ¶åˆ·æ–°æŒ‰é’®
        document.getElementById('force-refresh-btn')?.addEventListener('click', () => loadRecommendations(true));

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡ŒåŠ è½½æ¨è
        window.addEventListener('DOMContentLoaded', () => {
            loadRecommendations();
        });

        // å°†CONFIGæš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨
        window.CONFIG = CONFIG;
    </script>
</body>
</html> 