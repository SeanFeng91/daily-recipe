<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥é£Ÿè°±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-utensils"></i> æ¯æ—¥é£Ÿè°±
            </div>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> é¦–é¡µ</a>
                <a href="/history.html"><i class="fas fa-calendar-alt"></i> å†å²è®°å½•</a>
                <a href="/gallery.html"><i class="fas fa-camera"></i> æˆ‘çš„ä½œå“</a>
                <a href="/profile.html"><i class="fas fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="date-header">
            <h1>ä»Šæ—¥æ¨è <i class="fas fa-star" style="color: #ffd700;"></i></h1>
            <p id="current-date"></p>
            <div class="api-status">
                <button id="check-api" class="btn"><i class="fas fa-network-wired"></i> æ£€æŸ¥APIè¿æ¥</button>
                <span id="api-status-indicator"></span>
            </div>
        </div>

        <div class="recipes-grid" id="recipes-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½æ¨èèœå“...
            </div>
        </div>
        
        <div id="api-status-details" class="api-status-details" style="display: none;">
            <h3>APIè¿æ¥è¯Šæ–­</h3>
            <pre id="api-status-content"></pre>
        </div>

        <div id="api-status" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <h4>APIçŠ¶æ€</h4>
            <div id="api-status-content">æ­£åœ¨æ£€æŸ¥...</div>
            <button onclick="checkAPIStatus()">æ£€æŸ¥APIçŠ¶æ€</button>
        </div>
    </main>

    <script type="module">
        import { getDailyRecommendations, login, diagnoseAPI } from '/js/api.js';

        // è®¾ç½®å½“å‰æ—¥æœŸ
        const dateElement = document.getElementById('current-date');
        dateElement.textContent = new Date().toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // APIçŠ¶æ€æ£€æŸ¥
        document.getElementById('check-api').addEventListener('click', async () => {
            const statusIndicator = document.getElementById('api-status-indicator');
            const statusDetails = document.getElementById('api-status-details');
            const statusContent = document.getElementById('api-status-content');
            
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ£€æŸ¥ä¸­...';
            statusDetails.style.display = 'none';
            
            try {
                const diagnosticResults = await diagnoseAPI();
                
                if (diagnosticResults.tests.network.success && diagnosticResults.tests.health.success) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> APIè¿æ¥æ­£å¸¸';
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle" style="color: red;"></i> APIè¿æ¥å¼‚å¸¸';
                }
                
                statusContent.textContent = JSON.stringify(diagnosticResults, null, 2);
                statusDetails.style.display = 'block';
            } catch (error) {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> æ£€æŸ¥å¤±è´¥';
                statusContent.textContent = error.message;
                statusDetails.style.display = 'block';
            }
        });

        // åŠ è½½æ¨èèœå“
        async function loadRecommendations(forceRefresh = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const recommendationsContainer = document.getElementById('recommendations-container');
            
            loadingIndicator.style.display = 'block';
            recommendationsContainer.innerHTML = '';
            
            try {
                // æ·»åŠ å¼ºåˆ¶åˆ·æ–°å‚æ•°
                const url = forceRefresh ? 
                    '/api/clear-cache' : 
                    '/api/recommendations';
                
                // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆæ¸…é™¤ç¼“å­˜
                if (forceRefresh) {
                    await fetchAPI(url);
                }
                
                const recommendations = await getDailyRecommendations();
                console.log('è·å–åˆ°çš„æ¨è:', recommendations);
                
                // æ£€æŸ¥æ¨èæ˜¯å¦ä¸ºæ•°ç»„
                if (!Array.isArray(recommendations)) {
                    throw new Error('æ¨èæ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                // æ˜¾ç¤ºæ¨è
                recommendationsContainer.innerHTML = recommendations.map(recipe => `
                    <div class="recipe-card">
                        <h3>${recipe.èœå}</h3>
                        <p>${recipe.ç®€çŸ­æè¿°}</p>
                        <div class="recipe-details">
                            <span>ğŸ•’ ${recipe.æ‰€éœ€æ—¶é—´}</span>
                            <span>ğŸ“Š ${recipe.éš¾åº¦çº§åˆ«}</span>
                        </div>
                        <div class="recipe-ingredients">
                            <strong>ä¸»è¦é£Ÿæ:</strong> ${recipe.ä¸»è¦é£Ÿæ.join(', ')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æ¨èå¤±è´¥:', error);
                recommendationsContainer.innerHTML = `
                    <div class="error-message">
                        <p>åŠ è½½æ¨èå¤±è´¥: ${error.message}</p>
                        <button onclick="loadRecommendations(true)">é‡è¯•</button>
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆé€šè¿‡å°è¯•è·å–æ¨èæ¥åˆ¤æ–­ï¼‰
        async function checkLoginStatus() {
            try {
                await getDailyRecommendations();
                document.getElementById('loginBtn').style.display = 'none';
                loadRecommendations();
            } catch (error) {
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('recipes-container').innerHTML = '<p class="error">è¯·å…ˆç™»å½•</p>';
            }
        }

        // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('loginBtn').addEventListener('click', async () => {
            if (await login()) {
                checkLoginStatus();
            } else {
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkLoginStatus();

        // æ·»åŠ å¼ºåˆ¶åˆ·æ–°æŒ‰é’®
        document.addEventListener('DOMContentLoaded', () => {
            const controlsContainer = document.querySelector('.page-controls');
            if (controlsContainer) {
                const refreshButton = document.createElement('button');
                refreshButton.className = 'refresh-button';
                refreshButton.textContent = 'å¼ºåˆ¶åˆ·æ–°æ¨è';
                refreshButton.onclick = () => loadRecommendations(true);
                controlsContainer.appendChild(refreshButton);
            }
        });

        // æ·»åŠ APIçŠ¶æ€æ£€æŸ¥å‡½æ•°
        async function checkAPIStatus() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML = 'æ­£åœ¨æ£€æŸ¥...';
            
            try {
                // æ£€æŸ¥åŸºæœ¬å¥åº·çŠ¶æ€
                const health = await fetchAPI('/health');
                // æ£€æŸ¥è¯¦ç»†å¥åº·çŠ¶æ€
                const detailedHealth = await fetchAPI('/health/detailed');
                
                statusContent.innerHTML = `
                    <p><strong>APIçŠ¶æ€:</strong> ${health.status}</p>
                    <p><strong>JWTå¯†é’¥è®¾ç½®:</strong> ${health.env.hasJwtSecret ? 'âœ…' : 'âŒ'}</p>
                    <p><strong>GROQå¯†é’¥è®¾ç½®:</strong> ${health.env.hasGroqKey ? 'âœ…' : 'âŒ'}</p>
                    <p><strong>KVçŠ¶æ€:</strong> ${detailedHealth.kv}</p>
                    <p><strong>æ—¶é—´æˆ³:</strong> ${health.timestamp}</p>
                    <p><button onclick="testRecommendationAPI()">æµ‹è¯•æ¨èAPI</button></p>
                `;
            } catch (error) {
                statusContent.innerHTML = `<p>æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ·»åŠ æµ‹è¯•æ¨èAPIå‡½æ•°
        async function testRecommendationAPI() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML += '<p>æ­£åœ¨æµ‹è¯•æ¨èAPI...</p>';
            
            try {
                const startTime = Date.now();
                // ä½¿ç”¨nocacheå‚æ•°å¼ºåˆ¶è°ƒç”¨GROQ API
                const recommendations = await fetchAPI('/recommendations?nocache=true');
                const endTime = Date.now();
                
                statusContent.innerHTML += `
                    <p>æ¨èAPIå“åº”æ—¶é—´: ${endTime - startTime}ms</p>
                    <p>æ¨èæ•°é‡: ${Array.isArray(recommendations) ? recommendations.length : 'æœªçŸ¥'}</p>
                    <p>å†…å®¹æ ·ä¾‹: ${JSON.stringify(recommendations).substring(0, 100)}...</p>
                    <p><button onclick="loadRecommendations(true)">åˆ·æ–°é¡µé¢æ¨è</button></p>
                `;
            } catch (error) {
                statusContent.innerHTML += `<p>æ¨èAPIæµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html> 