<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日食谱</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-utensils"></i> 每日食谱
            </div>
            <div class="nav-links">
                <a href="/" class="active"><i class="fas fa-home"></i> 首页</a>
                <a href="/history.html"><i class="fas fa-calendar-alt"></i> 历史记录</a>
                <a href="/gallery.html"><i class="fas fa-camera"></i> 我的作品</a>
                <a href="/profile.html"><i class="fas fa-user"></i> 个人中心</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="date-header">
            <h1>今日推荐 <i class="fas fa-star" style="color: #ffd700;"></i></h1>
            <p id="current-date"></p>
            <div class="api-status">
                <button id="check-api" class="btn"><i class="fas fa-network-wired"></i> 检查API连接</button>
                <span id="api-status-indicator"></span>
            </div>
        </div>

        <div class="recipes-grid" id="recipes-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载推荐菜品...
            </div>
        </div>
        
        <div id="api-status-details" class="api-status-details" style="display: none;">
            <h3>API连接诊断</h3>
            <pre id="api-status-content"></pre>
        </div>

        <div id="api-status" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <h4>API状态</h4>
            <div id="api-status-content">正在检查...</div>
            <button onclick="checkAPIStatus()">检查API状态</button>
        </div>
    </main>

    <script type="module">
        import { getDailyRecommendations, login, diagnoseAPI } from '/js/api.js';

        // 设置当前日期
        const dateElement = document.getElementById('current-date');
        dateElement.textContent = new Date().toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // API状态检查
        document.getElementById('check-api').addEventListener('click', async () => {
            const statusIndicator = document.getElementById('api-status-indicator');
            const statusDetails = document.getElementById('api-status-details');
            const statusContent = document.getElementById('api-status-content');
            
            statusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
            statusDetails.style.display = 'none';
            
            try {
                const diagnosticResults = await diagnoseAPI();
                
                if (diagnosticResults.tests.network.success && diagnosticResults.tests.health.success) {
                    statusIndicator.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> API连接正常';
                } else {
                    statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle" style="color: red;"></i> API连接异常';
                }
                
                statusContent.textContent = JSON.stringify(diagnosticResults, null, 2);
                statusDetails.style.display = 'block';
            } catch (error) {
                statusIndicator.innerHTML = '<i class="fas fa-times-circle" style="color: red;"></i> 检查失败';
                statusContent.textContent = error.message;
                statusDetails.style.display = 'block';
            }
        });

        // 加载推荐菜品
        async function loadRecommendations(forceRefresh = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const recommendationsContainer = document.getElementById('recommendations-container');
            
            loadingIndicator.style.display = 'block';
            recommendationsContainer.innerHTML = '';
            
            try {
                // 添加强制刷新参数
                const url = forceRefresh ? 
                    '/api/clear-cache' : 
                    '/api/recommendations';
                
                // 如果是强制刷新，先清除缓存
                if (forceRefresh) {
                    await fetchAPI(url);
                }
                
                const recommendations = await getDailyRecommendations();
                console.log('获取到的推荐:', recommendations);
                
                // 检查推荐是否为数组
                if (!Array.isArray(recommendations)) {
                    throw new Error('推荐数据格式错误');
                }
                
                // 显示推荐
                recommendationsContainer.innerHTML = recommendations.map(recipe => `
                    <div class="recipe-card">
                        <h3>${recipe.菜名}</h3>
                        <p>${recipe.简短描述}</p>
                        <div class="recipe-details">
                            <span>🕒 ${recipe.所需时间}</span>
                            <span>📊 ${recipe.难度级别}</span>
                        </div>
                        <div class="recipe-ingredients">
                            <strong>主要食材:</strong> ${recipe.主要食材.join(', ')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载推荐失败:', error);
                recommendationsContainer.innerHTML = `
                    <div class="error-message">
                        <p>加载推荐失败: ${error.message}</p>
                        <button onclick="loadRecommendations(true)">重试</button>
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // 检查是否已登录（通过尝试获取推荐来判断）
        async function checkLoginStatus() {
            try {
                await getDailyRecommendations();
                document.getElementById('loginBtn').style.display = 'none';
                loadRecommendations();
            } catch (error) {
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('recipes-container').innerHTML = '<p class="error">请先登录</p>';
            }
        }

        // 登录按钮点击事件
        document.getElementById('loginBtn').addEventListener('click', async () => {
            if (await login()) {
                checkLoginStatus();
            } else {
                alert('登录失败，请重试');
            }
        });

        // 页面加载时检查登录状态
        checkLoginStatus();

        // 添加强制刷新按钮
        document.addEventListener('DOMContentLoaded', () => {
            const controlsContainer = document.querySelector('.page-controls');
            if (controlsContainer) {
                const refreshButton = document.createElement('button');
                refreshButton.className = 'refresh-button';
                refreshButton.textContent = '强制刷新推荐';
                refreshButton.onclick = () => loadRecommendations(true);
                controlsContainer.appendChild(refreshButton);
            }
        });

        // 添加API状态检查函数
        async function checkAPIStatus() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML = '正在检查...';
            
            try {
                // 检查基本健康状态
                const health = await fetchAPI('/health');
                // 检查详细健康状态
                const detailedHealth = await fetchAPI('/health/detailed');
                
                statusContent.innerHTML = `
                    <p><strong>API状态:</strong> ${health.status}</p>
                    <p><strong>JWT密钥设置:</strong> ${health.env.hasJwtSecret ? '✅' : '❌'}</p>
                    <p><strong>GROQ密钥设置:</strong> ${health.env.hasGroqKey ? '✅' : '❌'}</p>
                    <p><strong>KV状态:</strong> ${detailedHealth.kv}</p>
                    <p><strong>时间戳:</strong> ${health.timestamp}</p>
                    <p><button onclick="testRecommendationAPI()">测试推荐API</button></p>
                `;
            } catch (error) {
                statusContent.innerHTML = `<p>检查失败: ${error.message}</p>`;
            }
        }

        // 添加测试推荐API函数
        async function testRecommendationAPI() {
            const statusContent = document.getElementById('api-status-content');
            statusContent.innerHTML += '<p>正在测试推荐API...</p>';
            
            try {
                const startTime = Date.now();
                // 使用nocache参数强制调用GROQ API
                const recommendations = await fetchAPI('/recommendations?nocache=true');
                const endTime = Date.now();
                
                statusContent.innerHTML += `
                    <p>推荐API响应时间: ${endTime - startTime}ms</p>
                    <p>推荐数量: ${Array.isArray(recommendations) ? recommendations.length : '未知'}</p>
                    <p>内容样例: ${JSON.stringify(recommendations).substring(0, 100)}...</p>
                    <p><button onclick="loadRecommendations(true)">刷新页面推荐</button></p>
                `;
            } catch (error) {
                statusContent.innerHTML += `<p>推荐API测试失败: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html> 